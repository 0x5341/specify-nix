name: genlock-daily

on:
  schedule:
    - cron: '0 0 * * *' # 毎日 00:00 UTC（JST の毎日0時を希望なら '0 15 * * *' に変更）
  workflow_dispatch:

jobs:
  run-genlock:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1

      - name: Restore Nix store cache
        uses: nix-community/cache-nix-action@v6.1.3
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix','**/flake.lock') }}
          paths: |
            /nix
            ~/.cache/nix
            /root/.cache/nix

      - name: Install Determinate Nix
        # Pin to the latest Determinate Nix Action v3.x release for reproducibility
        uses: DeterminateSystems/determinate-nix-action@v3.13.1

      - name: Check flake (optional)
        # Use flake-checker to validate flake.lock and inputs. Pin to latest major tag.
        uses: DeterminateSystems/flake-checker-action@v12
        with:
          flake-lock-path: ./flake.lock
          fail-mode: false

      - name: Run genlock
        run: nix run .#genlock

      - name: Save Nix store cache
        if: always()
        uses: nix-community/cache-nix-action@v6.1.3
        with:
          primary-key: nix-${{ runner.os }}-${{ hashFiles('**/*.nix','**/flake.lock') }}
          paths: |
            /nix
            ~/.cache/nix
            /root/.cache/nix

      - name: Commit & push generated changes (if any)
        uses: EndBug/add-and-commit@v9
        with:
          author_name: 'github-actions[bot]'
          author_email: '41898282+github-actions[bot]@users.noreply.github.com'
          message: "chore: 自動生成ファイルを更新 (genlock実行)"
          add: "."
          branch: main
          push: true
